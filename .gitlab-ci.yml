stages:
  - build_container
  - deploy_to_local
  - deploy_to_local_staging


build_container:
  stage: build_container
  script:
    - echo "Building the app"
    - echo "-----------------------------------------------------------------"
    - echo "NOTE THAT ENV_FILE is a variable set up in the gitlab project settings CI/CD section Variables"
    - echo $ENV_FILE | sed 's/ /\n/g'
    - echo $ENV_FILE | sed 's/ /\n/g' > .env
    - docker network inspect backendnetwork >/dev/null 2>&1 || docker network create backendnetwork
    - docker-compose down
    - docker-compose build
  tags:
    - dockerexecutor
  only:
    - dev



deploy_to_local:
  stage: deploy_to_local
  script:
    - echo "Deploying to local environment"
    - echo "-----------------------------------------------------------------"
    - echo $ENV_FILE | sed 's/ /\n/g'
    - echo $ENV_FILE | sed 's/ /\n/g' > .env
    - docker-compose up -d
  tags:
    - dockerexecutor
  only:
    - dev

deploy_to_local_staging:
  stage: deploy_to_local_staging
  script:
    - echo "Deploying to local staging environment"
    - echo "-----------------------------------------------------------------"
    - docker-compose -f docker-compose.staging.yml up -d
  tags:
    - dockerexecutor
  only:
    - staging